<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Hour of Code</title>
        <link rel="stylesheet" href="styles.css">
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
        <script src="blockly/blockly_compressed.js"></script>
        <script src="blockly/javascript_compressed.js"></script>
        <script src="blockly/blocks_compressed.js"></script>
        <script src="blockly/msg/js/en.js"></script>
        <script src="code_blocks.js"></script>
        <!-- mediapipe imports -->
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <div id="levelUpModal" class="modal">
          <!-- Modal content -->
          <div class="modal-content">
            <span class="close">&times;</span>
            <p id="inject-text">Some text</p>
          </div>
        </div>
        <div id="blocklyDiv">
            <button id="run" onclick="runCode()">Click to Run!</button>
            <button id="reset" onclick="resetGUI()">Reset</button>
        </div>
        <div class="poseDiv">
			<video class="input_video" hidden></video>
			<canvas class="output_canvas"></canvas>
			<!-- <canvas class="output_canvas" width="1280px" height="720px"></canvas> -->
		</div>
        <canvas id="renderCanvas" touch-action="none"></canvas>
        <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <sep></sep>
        <category name="Click for Actions">
            <block type="create_sphere">
            <field name="NAME">small</field>
            </block>
            <block type="place"></block>
            <block type="dance"></block>
        </category>
        <!--<category name="Loops">
            <block type="controls_repeat_ext"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
        </category>-->
        </xml>
        <xml xmlns="https://developers.google.com/blockly/xml" id="workspaceBlocks" style="display: none"></xml>
        <script>
            var toolbox = document.getElementById("toolbox");
            var options = { 
                toolbox : toolbox, 
                collapse : true, 
                comments : true, 
                disable : true, 
                maxBlocks : Infinity, 
                trashcan : true, 
                horizontalLayout : false, 
                toolboxPosition : 'start', 
                css : true, 
                media : 'https://blockly-demo.appspot.com/static/media/', 
                rtl : false, 
                scrollbars : true, 
                sounds : true, 
                oneBasedIndex : true
            };
            /* Inject your Blockly workspace */ 
            var blocklyDiv =  document.getElementById('blocklyDiv');
            var workspace = Blockly.inject(blocklyDiv, options);
            var workspaceBlocks = document.getElementById("workspaceBlocks"); 
            Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
        </script>
        <script>
            function runCode() {
                window.LoopTrap = 1000;
                Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if(--window.LoopTrap == 0) throw "Infinite loop.";\n';
                var code = Blockly.JavaScript.workspaceToCode(workspace);
                try {
                    eval(code);
                } catch (e) {
                    alert(e);
                }
                runOnGUI();
                setTimeout(function() { 
                    document.activeElement.blur();
                }, 150);
            }
        </script>
        <script>
            var modal = document.getElementById("levelUpModal");
            var span = document.getElementsByClassName("close")[0];
            span.onclick = function() {
              modal.style.display = "none";
            }
            window.onclick = function(event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            }
        </script>
        <script src="scene.js"></script>
        <script type="module">
			const videoElement = document.getElementsByClassName('input_video')[0];
			const canvasElement = document.getElementsByClassName('output_canvas')[0];
			const canvasCtx = canvasElement.getContext('2d');

			function onResults(results) {
			  canvasCtx.save();
			  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
			  // console.log("hi")
			  // console.log(results.poseLandmarks[14].x)
			  canvasCtx.drawImage(
			      results.image, 0, 0, canvasElement.width, canvasElement.height);
			  // drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
			  //                {color: '#00FF00', lineWidth: 4});
			  // drawLandmarks(canvasCtx, results.poseLandmarks,
			  //               {color: '#FF0000', lineWidth: 2});
			  if(results.poseLandmarks[14].y < results.poseLandmarks[10].y){
			  	console.log("right up")
			  	alert("Run!")
			  }
			  canvasCtx.restore();
			}

			const pose = new Pose({locateFile: (file) => {
			  return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
			}});
			pose.setOptions({
			  upperBodyOnly: false,
			  smoothLandmarks: true,
			  minDetectionConfidence: 0.5,
			  minTrackingConfidence: 0.5
			});
			pose.onResults(onResults);

			const camera = new Camera(videoElement, {
			  onFrame: async () => {
			    await pose.send({image: videoElement});
			  },
			  width: 1280,
			  height: 720
			});
			camera.start();
		</script>
   </body>
</html>